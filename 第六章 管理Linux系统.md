### 管理Linux系统



**6**  设备

**7**  */proc*文件系统

**8**  Linux系统调用

**9**  内联汇编代码

**10** 安全

**11** GNU/Linux示例程序







### 6 设备

Linux系统像其他操作系统一样，内部通过叫做**设备驱动**的模块化的软件组件与硬件进行通信。设备驱动隐藏了操作系统与硬件通信的协议具体细节，同时给系统提供了标准的接口与硬件设备进行通信。

Linux系统下，设备驱动是内核的一部分，既能以静态链接的方式加入内核，也可以按需加载的方式成为内核模块。设备驱动以内核的一部分来运行，并且不会直接访问用户进程。但是Linux系统提供了可以和设备驱动通信的机制—通过一个"类文件对象"—操作硬件。这些文件对象都出现在文件系统中，并且程序也能打开这些文件对象，也可以像正常文件一样进行写操作。无论是通过Linux提供的低级I/O操作还是标准C语言库的I/O操作，都可以通过操作这些"类文件对象"与硬件通信。

Linux也提供几个类文件对象来直接与Linux内核通信，而不是通过设备驱动与Linux内核通信。这些文件不直接与硬件相链接。而是提供多种专门的接口给应用和系统程序。

> **访问设备时要小心!**
>
> 这章讲的技术是直接访问正运行在Linux内核中的设备驱动，并且通过它们来访问连接到系统内的硬件。使用这些技术时需要小心，如果滥用可能会损坏GNU/Linux系统。
>
> *详情看侧边 "块设备的危害"*。

### 6.1 设备类型

设备文件不同于普通文件—它们并不是在文件系统中的一块在磁盘上的数据区域。向设备文件中读取与写入数据相当于与对应的设备驱动通信，再由设备驱动到底层设备。设备文件有二种形态:

- `字符设备`表示这是可以读取或者写入一系列数据字节流的硬件设备。串行和并行接口，磁带设备，终端设备，还有声卡都属于字符设备。
- `块设备`表示这是可以在固定大小的块内读写数据的硬件设备。不像字符设备，块设备提供对存储在设备数据中随机访问功能。磁盘驱动器就是一个块设备。

平常的应用程序都不会用到块设备。虽然磁盘驱动器是块设备，但是每个磁盘分区里的内容通常都包含一个文件系统，同时这个文件系统挂载在GNU/Linux根文件系统树上。只有实现文件系统的内核代码才需要直接访问块设备；应用程序访问磁盘上的内容都是通过标准文件和目录来完成。

> **块设备危害**
>
> 块设备提供了直接访问磁盘驱动器数据的功能。即使大多数GNU/Linux系统都设置了非根进程不能直接访问这些设备，但是根进程还是可以通过改写磁盘上的内容对块设备造成严重危害。通过向磁盘块设备写入内容，程序可以修改或者毁掉文件系统控制信息，甚至是磁盘分区表和主启动记录，这样就直接导致驱动或者整个系统全部瘫痪。访问这些设备时一定要非常小心。

应用程序有时候会使用字符设备，接下来几节我们会讨论关于字符设备的内容。

### 6.2 设备编号

Linux标识设备使用二个数字: `主设备编号`和`次设备编号`。主设备编号用来表示哪个驱动对应哪个设备。对应主设备编号的驱动是固定写在内核代码中的。注意相同的主设备编号可能对应二个不同的设备，一个字符设备一个是块设备。次设备编号用来辨别单独的设备或者单独由一个驱动来控件的组件。

比如，主设备编号为3的对应系统中的主IDE控制器。IDE控制器可以有二个设备(磁盘，磁带，或者CD-ROM驱动器)附加在里面；"主"设备有一个次设备编号为0，"从"设备有一个次设备编号是64。"主"设备上单独的分区(假设设备支持分区)依次由次设备编号1，2，3这样类推。"从"设备上单独的分区依次由次设备编号65，66，67这样类推。

主设备编号都列在Linux内核代码文档中。在多数的GNU/Linux发行版中，可以在`usr/src/linux/Documention/devices.txt`中找到。`/proc/devices`这个特殊的入口列出了当前内核已加载的设备与驱动相对应的主设备编号(查看第七章，"/proc 文件系统"，获得更多关于`/proc`文件系统的入口)。

###  6.3 设备入口

设备入口很多时候都一个标准的文件。你可以用`mv`命令移动这个文件，也可以用`rm`命令删除这个文件。如果你用`cp`命令拷贝这个文件，其实就是从设备中读取字节数据(假设这个设备支持读取)再写入到目标文件。如果你想覆盖设备入口，你只需要向对应的设备写入字节数据即可。

你可以用`mknod`命令(使用`man 1 mknod`查看手册)或者调用`mknod`系统函数(使用`man 2 mknod`查看手册)在文件系统中创建设备入口。在文件系统中创建设备入口并不会自动让到对应的设备驱动或者硬件设备立即可用；如果有了设备入口，这仅仅是与驱动器通信的入口。只有超级用户进程才能通过`mknod`命令或者`mknod`系统调用创建块设备和字符设备。

使用`mknod`命令创建设备，第一个参数指定入口文件在文件系统中的路径。第二个参数，`b`表示是块设备，`c`表示是字符设备。第三个和第四个参数分别对应主设备编号与次设备编号。例如下这个命令创建一个字符设备入口，名字是`lp0`，路径是当前目录，主设备编号是6，次设备编号是0。这些数字表示Linux系统上的第一个并行端口。

```shell
% mknod ./lp0 c 6 0
```

记住只有超级用户进程能创建字符设备与块设备。所以你必须以`root`用户登陆才能成功调用这个命令。

`ls`命令用来显示指定的设备入口。如果你用`ls`命令的时候带了`-l`或者`-o`选项，那么命令每行的输入第一个字符就表示当前入口的类型。记住`-`(中划线)表示是标准文件，`d`表示是目录。类似，`b`表示块设备，`c`表示字符设备。

